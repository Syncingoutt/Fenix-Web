name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - fix

jobs:
  release:
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get latest tag
        id: get_tag
        shell: pwsh
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Get the latest tag (sorted by version)
          $tags = git tag -l "v*" | Sort-Object { [version]($_ -replace '^v', '') }
          $LATEST_TAG = if ($tags.Count -gt 0) { $tags[-1] } else { "" }
          
          if ([string]::IsNullOrEmpty($LATEST_TAG)) {
            Write-Host "No existing tags found, starting from v2.0.0"
            $CURRENT_VERSION = "2.0.0"
            "version=$CURRENT_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            "tag=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            # Extract version from tag (remove 'v' prefix)
            $CURRENT_VERSION = $LATEST_TAG -replace '^v', ''
            "version=$CURRENT_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            "tag=$LATEST_TAG" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }
          
          Write-Host "Current version: $CURRENT_VERSION"
          Write-Host "Latest tag: $LATEST_TAG"

      - name: Calculate next version
        id: calc_version
        shell: pwsh
        run: |
          $CURRENT_VERSION = "${{ steps.get_tag.outputs.version }}"
          $VERSION_TYPE = "${{ github.event.inputs.version_type }}"
          
          $parts = $CURRENT_VERSION -split '\.'
          $MAJOR = [int]$parts[0]
          $MINOR = [int]$parts[1]
          $PATCH = [int]$parts[2]
          
          switch ($VERSION_TYPE) {
            "major" {
              $MAJOR++
              $MINOR = 0
              $PATCH = 0
            }
            "minor" {
              $MINOR++
              $PATCH = 0
            }
            "fix" {
              $PATCH++
            }
          }
          
          $NEW_VERSION = "$MAJOR.$MINOR.$PATCH"
          $NEW_TAG = "v$NEW_VERSION"
          
          Write-Host "New version: $NEW_VERSION"
          Write-Host "New tag: $NEW_TAG"
          
          # Set GitHub Actions outputs (write directly without Write-Host)
          "version=$NEW_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "tag=$NEW_TAG" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Update package.json version (temporary)
        shell: pwsh
        run: |
          $NEW_VERSION = "${{ steps.calc_version.outputs.version }}"
          
          # Read current version from package.json
          $packageJson = Get-Content -Path package.json -Raw | ConvertFrom-Json
          $CURRENT_VERSION = $packageJson.version
          
          if ($CURRENT_VERSION -eq $NEW_VERSION) {
            Write-Host "‚ö†Ô∏è  Version already set to $NEW_VERSION, skipping update"
          } else {
            Write-Host "Updating version from $CURRENT_VERSION to $NEW_VERSION"
            npm version $NEW_VERSION --no-git-tag-version
            Write-Host "‚úÖ Updated package.json to version $NEW_VERSION"
          }

      - name: Build Electron app
        run: npm run build && npx electron-builder --publish never

      - name: Commit version bump
        shell: pwsh
        run: |
          $NEW_VERSION = "${{ steps.calc_version.outputs.version }}"
          $NEW_TAG = "${{ steps.calc_version.outputs.tag }}"
          
          git add package.json package-lock.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push origin main

      - name: Create and push tag
        shell: pwsh
        run: |
          $NEW_TAG = "${{ steps.calc_version.outputs.tag }}"
          Write-Host "Creating tag: $NEW_TAG"
          if ([string]::IsNullOrWhiteSpace($NEW_TAG)) {
            Write-Host "‚ùå Error: NEW_TAG is empty!"
            Write-Host "calc_version outputs:"
            Write-Host "  version: ${{ steps.calc_version.outputs.version }}"
            Write-Host "  tag: ${{ steps.calc_version.outputs.tag }}"
            exit 1
          }
          git tag $NEW_TAG
          git push origin $NEW_TAG

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $RELEASE_NOTES = @"
          ## Release ${{ steps.calc_version.outputs.tag }}
          
          Automated release created from ${{ github.ref_name }} branch.
          
          ### Changes
          See commit history for details.
          "@
          
          # Find NSIS installer and update metadata files
          $installerFiles = Get-ChildItem -Path release -Filter "*.exe" -File | ForEach-Object { $_.FullName }
          $ymlFiles = Get-ChildItem -Path release -Filter "*.yml" -File | ForEach-Object { $_.FullName }
          $blockmapFiles = Get-ChildItem -Path release -Filter "*.blockmap" -File | ForEach-Object { $_.FullName }
          
          # Combine all files needed for auto-updates (exclude debug files)
          $allFiles = @()
          if ($installerFiles) {
            $allFiles += $installerFiles | Where-Object { $_ -notlike "*debug*" }
          }
          if ($ymlFiles) {
            $allFiles += $ymlFiles | Where-Object { $_ -like "*latest.yml" }
          }
          if ($blockmapFiles) {
            $allFiles += $blockmapFiles
          }
          
          if ($installerFiles.Count -eq 0) {
            Write-Host "‚ö†Ô∏è  No installer files found in release directory"
            Get-ChildItem -Path release
            exit 1
          }
          
          $latestYml = $ymlFiles | Where-Object { $_ -like "*latest.yml" }
          if ($latestYml.Count -eq 0) {
            Write-Host "‚ö†Ô∏è  WARNING: No latest.yml file found - auto-updates may not work!"
            Write-Host "Files in release directory:"
            Get-ChildItem -Path release
          } else {
            Write-Host "‚úÖ Found latest.yml file for auto-updates"
          }
          
          Write-Host "Files to upload:"
          $allFiles | ForEach-Object { Write-Host "  $_" }
          
          # Build gh release create command with properly quoted file paths
          $releaseTag = "${{ steps.calc_version.outputs.tag }}"
          $releaseTitle = "Release $releaseTag"
          
          # Start building the command arguments
          $ghArgs = @(
            "release",
            "create",
            $releaseTag,
            "--title",
            $releaseTitle,
            "--notes",
            $RELEASE_NOTES,
            "--repo",
            "${{ github.repository }}"
          )
          
          # Add each file as a separate argument (gh will handle the paths)
          foreach ($file in $allFiles) {
            $ghArgs += $file
          }
          
          # Execute gh with arguments
          & gh $ghArgs

      - name: Release summary
        shell: pwsh
        run: |
          @"
          ## üéâ Release Complete

          - **Version**: ${{ steps.calc_version.outputs.version }}
          - **Tag**: ${{ steps.calc_version.outputs.tag }}
          - **Release Type**: ${{ github.event.inputs.version_type }}

          View the release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.calc_version.outputs.tag }}
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
